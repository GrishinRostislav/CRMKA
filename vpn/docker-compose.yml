version: "3.8"
services:
  wg-easy:
    environment:
      - LANG=ru
      - WG_HOST=158.69.205.142
      - PASSWORD_HASH=$$2a$$12$$a/aX5.3l1Ezdszp0XyFRn.ZafaDu5/WVTMfpvZNVtiamdNYQTuVYe
      - WG_PORT=51820
      - WG_DEFAULT_ADDRESS=10.8.0.x
      - WG_DEFAULT_DNS=1.1.1.1
      - WG_ALLOWED_IPS=0.0.0.0/0
      - WG_persistent_keepalive=25
    image: ghcr.io/wg-easy/wg-easy
    container_name: wg-easy
    volumes:
      - ./config:/etc/wireguard
    ports:
      - "51820:51820/udp"
      - "51821:51821/tcp"
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1

  # Reads WireGuard metrics
  wireguard-exporter:
    image: mindflavor/prometheus-wireguard-exporter:latest
    container_name: wireguard-exporter
    # TRICK: Run in the same network namespace as wg-easy to see the 'wg0' interface!
    network_mode: "service:wg-easy"
    cap_add:
      - NET_ADMIN # Needed to query the interface
    command:
      - "-a"
      - "true" # Enable metrics for all peers
      # Since we are in the same network namespace, we bind to localhost inside that namespace.
      # BUT, Prometheus is in a different container. 
      # Actually, 'network_mode: service:wg-easy' makes localhost shared. 
      # So Prometheus connects to 'wg-easy:9586'.
    restart: unless-stopped

  prometheus:
    image: prom/prometheus
    container_name: vpn-prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    restart: unless-stopped
    # It needs to talk to wg-easy container (where exporter lives on localhost)
    # Since exporter shares net with wg-easy, we can access it via 'wg-easy' hostname in the bridge network?
    # No, 'network_mode: service' removes the container from the default bridge DNS if not handled carefully.
    # PROPER WAY:
    # Exporter is essentially running INSIDE wg-easy's network.
    # So Prometheus should target 'wg-easy:9586'.
    depends_on:
      - wg-easy

  grafana:
    image: grafana/grafana
    container_name: vpn-grafana
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
      - grafana_data:/var/lib/grafana
    ports:
      - "3002:3000"
    restart: unless-stopped

volumes:
  prometheus_data:
  grafana_data:
